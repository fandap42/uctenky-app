# ===========================================
# Uctenky App - Production Docker Compose
# ===========================================
# Usage:
#   1. Copy .env.example to .env and fill in real values
#   2. docker compose -f docker-compose.prod.yml up -d
#   3. First run: docker compose -f docker-compose.prod.yml exec app node scripts/setup-minio.js
#
# The app image is pulled from Docker Hub (built by GitHub Actions CI/CD).
# Watchtower auto-updates the app when a new image is pushed.

services:
  # --- APPLICATION ---
  app:
    image: fandap42/uctenky-app:latest
    container_name: uctenky-app
    restart: always
    command: sh -c "./node_modules/.bin/prisma migrate deploy && node server.js"
    ports:
      - "3001:3000"
    environment:
      DATABASE_URL: "postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB}"
      AUTH_SECRET: "${AUTH_SECRET}"
      AUTH_URL: "${AUTH_URL}"
      AUTH_TRUST_HOST: "true"
      AUTH_SLACK_ID: "${AUTH_SLACK_ID}"
      AUTH_SLACK_SECRET: "${AUTH_SLACK_SECRET}"
      SLACK_ALLOWED_TEAM_ID: "${SLACK_ALLOWED_TEAM_ID}"
      S3_ENDPOINT: "http://minio:9000"
      S3_ACCESS_KEY: "${S3_ACCESS_KEY}"
      S3_SECRET_KEY: "${S3_SECRET_KEY}"
      S3_BUCKET: "${S3_BUCKET:-receipts}"
      S3_PUBLIC_ENDPOINT: "${S3_PUBLIC_ENDPOINT}"
      ENCRYPTION_KEY: "${ENCRYPTION_KEY}"
    depends_on:
      postgres:
        condition: service_healthy
      minio:
        condition: service_healthy
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # --- DATABASE ---
  postgres:
    image: postgres:16-alpine
    container_name: uctenky-db
    restart: always
    # No host port exposed in production (only internal Docker network)
    environment:
      POSTGRES_USER: "${POSTGRES_USER}"
      POSTGRES_PASSWORD: "${POSTGRES_PASSWORD}"
      POSTGRES_DB: "${POSTGRES_DB}"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}"]
      interval: 5s
      timeout: 5s
      retries: 5

  # --- OBJECT STORAGE (MinIO / S3) ---
  minio:
    image: minio/minio
    container_name: uctenky-minio
    restart: always
    ports:
      - "9001:9001"   # Web Console only (for admin access)
      - "9000:9000"   # S3 API (internal and external)
    environment:
      MINIO_ROOT_USER: "${MINIO_ROOT_USER}"
      MINIO_ROOT_PASSWORD: "${MINIO_ROOT_PASSWORD}"
    volumes:
      - minio_data:/data
    command: server /data --console-address ":9001"
    healthcheck:
      test: ["CMD", "mc", "ready", "local"]
      interval: 5s
      timeout: 5s
      retries: 5

  # --- AUTO UPDATE (Watchtower) ---
  watchtower:
    image: containrrr/watchtower
    container_name: uctenky-watchtower
    restart: unless-stopped
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    # --cleanup: Remove old images after update
    # --interval 300: Check for updates every 5 minutes
    # --label-enable: Only watch containers with label
    command: --cleanup --interval 300
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"

  # --- DATABASE BACKUP ---
  db-backup:
    image: prodrigestivill/postgres-backup-local
    container_name: uctenky-db-backup
    restart: always
    user: postgres:postgres
    volumes:
      - ./backups:/backups
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      POSTGRES_HOST: postgres
      POSTGRES_DB: "${POSTGRES_DB}"
      POSTGRES_USER: "${POSTGRES_USER}"
      POSTGRES_PASSWORD: "${POSTGRES_PASSWORD}"
      SCHEDULE: "@daily"
      BACKUP_KEEP_DAYS: "7"
      BACKUP_KEEP_WEEKS: "4"
      BACKUP_KEEP_MONTHS: "3"
      HEALTHCHECK_PORT: "8080"
# --- DATABASE MANAGEMENT (pgAdmin) ---
  pgadmin:
    image: dpage/pgadmin4
    container_name: uctenky-pgadmin
    restart: always
    environment:
      PGADMIN_DEFAULT_EMAIL: "${PGADMIN_MAIL}"
      PGADMIN_DEFAULT_PASSWORD: "${PGADMIN_PASSWORD}"
      PGADMIN_CONFIG_ENHANCED_COOKIE_PROTECTION: "False" # NutnĂ©, pokud nepouĹľĂ­vĂˇĹˇ HTTPS hned od zaÄŤĂˇtku
    ports:
      - "5050:80"
    depends_on:
      - postgres
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "1"

volumes:
  postgres_data:
  minio_data:

